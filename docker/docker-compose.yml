version: '3.8'

services:
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    ports:
      - "61208:61208"
    environment:
      - GLANCES_OPT=-w
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/rootfs:ro
    pid: host
    networks:
      - monitoring

  glancewatch:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: glancewatch
    restart: unless-stopped
    ports:
      - "8100:8000"
    environment:
      - GLANCES_BASE_URL=http://glances:61208/api/4
      - RAM_THRESHOLD=80.0
      - CPU_THRESHOLD=80.0
      - DISK_THRESHOLD=85.0
      - DISK_MOUNTS=/rootfs/var/lib
      - LOG_LEVEL=DEBUG
    depends_on:
      - glances
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  monitoring:
    driver: bridge
